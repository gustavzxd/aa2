<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Ocorr√™ncias</title>
    <link rel="stylesheet" href="/static/css/theme.css">
    <style>
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .btn-voltar {
            background-color: #6c757d;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-voltar:hover {
            background-color: #5a6268;
            color: white;
            text-decoration: none;
        }
        
        .btn-nova {
            background-color: var(--success-color);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-nova:hover {
            background-color: #218838;
            color: white;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <div class="page-container">
        <div class="page-header">
            <div>
                <h1 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    üìã Ocorr√™ncias Registradas
                </h1>
                <p style="margin: 5px 0 0 0; color: #666;">Total: <span id="total-ocorrencias">0</span></p>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="/index" class="btn-voltar">‚Üê Voltar</a>
                <a href="/mapa" class="btn-nova">‚ûï Nova Ocorr√™ncia</a>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Data/Hora</th>
                        <th>Tipo</th>
                        <th>Prioridade</th>
                        <th>Localiza√ß√£o</th>
                        <th>Coordenadas</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpo">
                    <tr id="loading-row">
                        <td colspan="7" class="loading">Carregando ocorr√™ncias...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function carregar() {
            const loadingRow = document.getElementById('loading-row');

            fetch('/ocorrencias', {
                    credentials: 'include'
                })
                .then(res => {
                    if (res.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    return res.json();
                })
                .then(d => {
                    loadingRow.style.display = 'none';

                    const corpo = document.getElementById("corpo");
                    corpo.innerHTML = "";

                    if (!d || d.error || d.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h3>Nenhuma ocorr√™ncia registrada</h3>
                            <p>Clique em "Nova Ocorr√™ncia" para come√ßar</p>
                        </td>
                    `;
                        corpo.appendChild(tr);
                        document.getElementById('total-ocorrencias').textContent = '0';
                        return;
                    }

                    document.getElementById('total-ocorrencias').textContent = d.length;

                    d.sort((a, b) => b.id - a.id);

                    d.forEach(o => {
                        const tr = document.createElement("tr");

                        let prioridadeClass = '';
                        let prioridadeEmoji = '';
                        switch (o.prioridade) {
                            case 'Alta':
                                prioridadeClass = 'btn-danger';
                                prioridadeEmoji = 'üî¥';
                                break;
                            case 'M√©dia':
                                prioridadeClass = 'btn-warning';
                                prioridadeEmoji = 'üü°';
                                break;
                            case 'Baixa':
                                prioridadeClass = 'btn-success';
                                prioridadeEmoji = 'üü¢';
                                break;
                        }

                        tr.innerHTML = `
                        <td><strong>#${o.id}</strong></td>
                        <td>
                            <small>${o.data}</small><br>
                            <small>${o.hora}</small>
                        </td>
                        <td>${o.tipo}</td>
                        <td>
                            <span class="btn ${prioridadeClass}" style="padding: 4px 8px; font-size: 12px;">
                                ${prioridadeEmoji} ${o.prioridade}
                            </span>
                        </td>
                        <td style="max-width: 250px;">
                            <small title="${o.endereco}">
                                ${o.endereco.length > 40 ? o.endereco.substring(0, 40) + '...' : o.endereco}
                            </small>
                        </td>
                        <td>
                            <small>${o.lat.toFixed(4)}, ${o.lon.toFixed(4)}</small>
                        </td>
                        <td>
                            <button class="btn btn-danger" onclick="excluir(${o.id})" style="padding: 6px 12px;">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    `;
                        corpo.appendChild(tr);
                    });
                })
                .catch(error => {
                    loadingRow.innerHTML = `
                    <td colspan="7" style="color: #dc3545; text-align: center;">
                        ‚ùå Erro ao carregar: ${error.message}
                    </td>
                `;
                });
        }

        function excluir(id) {
            if (!confirm(`Excluir ocorr√™ncia #${id}?`)) return;

            fetch('/excluir_ocorrencia', {
                    method: "POST",
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.ok) {
                        alert('‚úÖ Ocorr√™ncia exclu√≠da!');
                        carregar();
                    } else {
                        alert('‚ùå Erro: ' + (data.error || 'Tente novamente'));
                    }
                })
                .catch(error => {
                    alert('‚ùå Erro de conex√£o');
                });
        }

        document.addEventListener('DOMContentLoaded', carregar);
    </script>
</body>

</html>